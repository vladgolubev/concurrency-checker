orbs:
  node: circleci/node@1.1.6
  aws-cli: circleci/aws-cli@1.3.0
  jira: circleci/jira@1.1.3

commands:
  install_deps:
    steps:
      - node/with-cache:
          cache-version: v1-all
          cache-key: yarn.lock
          dir: ~/repo/node_modules
          use-strict-cache: true
          steps:
            - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> .npmrc
            - run: yarn install --pure-lockfile --ignore-scripts --no-progress

  install_prod_deps:
    steps:
      - node/with-cache:
          cache-version: v1-prod
          cache-key: yarn.lock
          dir: ~/repo/node_modules
          use-strict-cache: true
          steps:
            - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> .npmrc
            - run: yarn install --prod --pure-lockfile --ignore-scripts --no-progress

  install_sls:
    steps:
      - run:
          name: install serverless
          command: |
            curl -o- -L https://slss.io/install | bash
            sudo mv ~/.serverless/bin/serverless /usr/local/bin/serverless

  with_env_vars_from_ssm:
    parameters:
      env_var:
        type: string
      ssm_param:
        type: string
    steps:
      - run:
          name: fetch from ssm
          command: |
            echo "export << parameters.env_var >>=$(npx @shelf/aws-ssm-get-param-cli /$ENVIRONMENT<< parameters.ssm_param >>)" >> /tmp/ssm

  create_zip:
    steps:
      - run:
          name: cleanup node_modules junk
          command: |
            npx del-cli \
              "node_modules/**/@types/**" \
              "node_modules/**/*.d.ts" \
              "node_modules/**/.yarn-integrity" \
              "node_modules/**/.bin"

      - run:
          name: create artifact zip with code and node modules
          command: |
            zip --quiet -r --exclude="node_modules/aws-sdk/*" \
              artifact.zip \
              lib node_modules

  package:
    steps:
      - checkout
      - attach_workspace:
          at: ~/repo

      # install dev deps to use Serverless CLI to generate CloudFormation template
      - run: rm -rf node_modules
      - install_deps

      # generate CloudFormation template via Serverless CLI
      - install_sls
      - run: yarn package

      - persist_to_workspace:
          root: ~/repo
          paths:
            - .serverless
            - artifact.zip

  deploy:
    steps:
      - checkout
      - install_deps
      - attach_workspace:
          at: ~/repo

      - install_sls
      - run: yarn deploy

  enable_api_gw_xray:
    parameters:
      api_name:
        type: string
    steps:
      - run:
          name: Enable API GW X-Ray
          command: |
            API_NAME="$ENVIRONMENT-<< parameters.api_name >>"
            API_ID=$(aws apigateway get-rest-apis \
              --query="(items[?name == '$API_NAME'].id)" \
              --output text
            )
            aws apigateway update-stage \
              --rest-api-id="$API_ID" \
              --stage-name="$ENVIRONMENT" \
              --patch-operations="op=replace,path=/tracingEnabled,value=true"

  create_base_path_mapping:
    parameters:
      api_name:
        type: string
      base_path:
        type: string
    steps:
      - with_env_vars_from_ssm:
          env_var: API_HOST
          ssm_param: /shelf_api_domain
      - run:
          name: Create API GW Base Path Mapping
          command: |
            API_NAME="$ENVIRONMENT-<< parameters.api_name >>"
            API_ID=$(aws apigateway get-rest-apis \
              --query="(items[?name == '$API_NAME'].id)" \
              --output text
            )
            aws apigateway create-base-path-mapping \
              --domain-name="$API_HOST" \
              --rest-api-id="$API_ID" \
              --base-path="<< parameters.base_path >>" \
              --stage="$ENVIRONMENT" || true

version: 2.1

jobs:
  tests:
    executor:
      name: node/default
      tag: '12'
    working_directory: ~/repo
    environment:
      JEST_JUNIT_OUTPUT_DIR: './test-results/jest'
      JEST_JUNIT_OUTPUT_NAME: 'results.xml'
    steps:
      - checkout
      - install_deps

      - run: yarn coverage --maxWorkers=4
      - run: yarn lint:ci
      - run: yarn type-check

      - store_test_results:
          path: test-results

  create_artifact_zip:
    executor:
      name: node/default
      tag: '12'
    working_directory: ~/repo
    steps:
      - checkout

      # install dev deps to babelify code
      - install_deps
      - run: yarn build

      # install prod deps to create artifact zip
      - run: rm -rf node_modules
      - install_prod_deps

      - create_zip

      - persist_to_workspace:
          root: ~/repo
          paths:
            - artifact.zip

  package:
    executor:
      name: node/default
      tag: '12'
    working_directory: ~/repo
    steps:
      - package

  deploy:
    executor:
      name: node/default
      tag: '12'
    working_directory: ~/repo
    steps:
      - deploy

  api_gw_config:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup

      - enable_api_gw_xray:
          api_name: xxxxxx

      - create_base_path_mapping:
          api_name: xxxxxx
          base_path: xxxxxx

  run_api_tests:
    executor:
      name: node/default
      tag: '12'
    working_directory: ~/repo
    environment:
      API_HOST: api.gsstaging.net
    steps:
      - checkout
      - install_deps
      - with_env_vars_from_ssm:
          env_var: API_HOST
          ssm_param: /shelf_api_domain
      - run:
          name: run tests
          command: |
            source /tmp/ssm
            yarn test:integration

workflows:
  version: 2

  build_deploy:
    jobs:
      - tests:
          context: npm

      - create_artifact_zip:
          context: npm

      - package:
          name: package_staging_us
          context: staging-us
          requires:
            - create_artifact_zip
          filters:
            branches:
              only:
                - develop
                - /feature.*/
          post-steps:
            - jira/notify:
                environment_type: staging
                job_type: build

      - package:
          name: package_prod_us
          context: prod-us
          requires:
            - create_artifact_zip
          filters:
            branches:
              only:
                - master
                - /release.*/
          post-steps:
            - jira/notify:
                environment_type: production
                job_type: build

      - deploy:
          name: deploy_staging_us
          context: staging-us
          requires:
            - tests
            - package_staging_us
          filters:
            branches:
              only:
                - develop
          post-steps:
            - jira/notify:
                environment_type: staging
                job_type: deployment

      - deploy:
          name: deploy_prod_us
          context: prod-us
          requires:
            - tests
            - package_prod_us
          filters:
            branches:
              only:
                - master
          post-steps:
            - jira/notify:
                environment_type: production
                job_type: deployment

      - api_gw_config:
          name: api_gw_config_staging_us
          context: staging-us
          requires:
            - deploy_staging_us

      - api_gw_config:
          name: api_gw_config_prod_us
          context: prod-us
          requires:
            - deploy_prod_us

      - run_api_tests:
          name: run_api_tests_staging_us
          context: staging-us
          requires:
            - deploy_staging_us

      - run_api_tests:
          name: run_api_tests_prod_us
          context: prod-us
          requires:
            - deploy_prod_us

      - package_staging_eu:
          context: staging-eu
          requires:
            - create_artifact_zip
          filters:
            branches:
              only:
                - develop
          post-steps:
            - jira/notify:
                environment_type: staging
                job_type: build

      - package_prod_eu:
          context: prod-eu
          requires:
            - create_artifact_zip
          filters:
            branches:
              only:
                - master
                - /release.*/
          post-steps:
            - jira/notify:
                environment_type: production
                job_type: build

      - deploy_staging_eu:
          context: staging-eu
          requires:
            - tests
            - package_staging_eu
          filters:
            branches:
              only:
                - develop
          post-steps:
            - jira/notify:
                environment_type: staging
                job_type: deployment

      - deploy_prod_eu:
          context: prod-eu
          requires:
            - tests
            - package_prod_eu
          filters:
            branches:
              only:
                - master
          post-steps:
            - jira/notify:
                environment_type: production
                job_type: deployment

      - api_gw_config:
          name: api_gw_config_staging_eu
          context: staging-eu
          requires:
            - deploy_staging_eu

      - api_gw_config:
          name: api_gw_config_prod_eu
          context: prod-eu
          requires:
            - deploy_prod_eu

      - run_api_tests:
          name: run_api_tests_staging_eu
          context: staging-eu
          requires:
            - deploy_staging_eu

      - run_api_tests:
          name: run_api_tests_prod_eu
          context: prod-eu
          requires:
            - deploy_prod_eu
